<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.79.1" /><link rel="canonical" type="text/html" href="https://jvmperf.net/docs/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Workshop | jvmperf: Java Performance Workshop</title><meta property="og:title" content="Workshop" />
<meta property="og:description" content="Java performance workshop that leverages open-source tooling to discover how your JVM is performing." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jvmperf.net/docs/" />
<meta property="og:site_name" content="jvmperf: Java Performance Workshop" />
<meta itemprop="name" content="Workshop">
<meta itemprop="description" content="Java performance workshop that leverages open-source tooling to discover how your JVM is performing.">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Workshop"/>
<meta name="twitter:description" content="Java performance workshop that leverages open-source tooling to discover how your JVM is performing."/>





<link rel="preload" href="/scss/main.min.d365b133824fa7cc9e634c8a9ba97597f3759b03ad3fd78d42c3d136099b4543.css" as="style">
<link href="/scss/main.min.d365b133824fa7cc9e634c8a9ba97597f3759b03ad3fd78d42c3d136099b4543.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>



  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="font-weight-bold"><i class="fas fa-cube"></i>&nbsp;&nbsp;jvmperf</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/docs/" ><span class="active">Workshop</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.3c666f911f6c68f98dcc241f0422840f.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Workshop</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-a5f739a8bec034e3bccefb4740e1c6ec">Process and Threads</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-9a22b492f19ba508a502052a88896ceb">Java Mission Control &amp; Flight Recorder</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-bc241cfaf9ff21a46f29fd6eb5c89ce6">Introduction</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-81ae492cca539f3173a8a08bae892da5">Advanced Flight Recorder</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-6ef11477fa79b0d64946ef4b156240fc">Memory Analysis</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-b09263a61c61dd500a73a2e9c3ccb14a">Memory Heap Analysis</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-c6512c461f5f3bf1ba4ced486f736874">Garbage Collections</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a5f739a8bec034e3bccefb4740e1c6ec">1 - Process and Threads</h1>
    <div class="lead">Initial look at the JVM from its native perspective.</div>
	<p>This first part of the workshop, we will begin to learn about looking at the JVM from its native perspective, and begin obtaining JVM based information to correlate to it&rsquo;s native representation.</p>
<h2 id="top">top</h2>
<p>A very common utility as to monitor processes in Linux. For our case, we will want to monitor our JVM process. When just executing <code>top</code>, you will see all processes on the host:</p>
<pre><code>top - 05:32:51 up 8 min,  1 user,  load average: 0.05, 0.12, 0.06
Tasks:  62 total,   1 running,  61 sleeping,   0 stopped,   0 zombie
Cpu(s): 11.2%us,  0.7%sy,  0.0%ni, 87.8%id,  0.0%wa,  0.0%hi,  0.0%si,  0.3%st
Mem:   1020184k total,   466284k used,   553900k free,    17740k buffers
Swap:        0k total,        0k used,        0k free,   289500k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 6730 ec2-user  20   0 2246m 108m  13m S 10.3 10.9   0:14.11 java
    1 root      20   0 19596 1616 1292 S  0.0  0.2   0:00.56 init
    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0     0    0    0 S  0.0  0.0   0:00.02 ksoftirqd/0
    4 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kworker/0:0
    5 root       0 -20     0    0    0 S  0.0  0.0   0:00.00 kworker/0:0H
    6 root      20   0     0    0    0 S  0.0  0.0   0:00.04 kworker/u30:0
    7 root      20   0     0    0    0 S  0.0  0.0   0:00.27 rcu_sched
    8 root      20   0     0    0    0 S  0.0  0.0   0:00.00 rcu_bh
    9 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 migration/0
</code></pre><p>You can switch in this view to also view the native threads, by hitting <code>Shift+H</code>.</p>
<pre><code>top - 05:34:15 up 9 min,  1 user,  load average: 0.01, 0.09, 0.05
Tasks: 101 total,   1 running, 100 sleeping,   0 stopped,   0 zombie
Cpu(s):  4.0%us,  0.3%sy,  0.0%ni, 95.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   1020184k total,   491176k used,   529008k free,    17804k buffers
Swap:        0k total,        0k used,        0k free,   312648k cached
 Show threads On
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 6736 ec2-user  20   0 2246m 109m  13m S  2.0 11.0   0:05.72 java
 6737 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:01.69 java
 6740 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:01.67 java
 6746 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:00.31 java
 6768 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:00.03 java
 6778 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:00.08 java
 6777 ec2-user  20   0 15224 1332 1032 R  0.3  0.1   0:00.04 top
    1 root      20   0 19596 1616 1292 S  0.0  0.2   0:00.56 init
    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0     0    0    0 S  0.0  0.0   0:00.02 ksoftirqd/0
    4 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kworker/0:0
</code></pre><p>With these native threads, you can now get better context of what resources are being utilized. To simplify this, you can target top to just watch one parent process and then show threads via:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">top -H -p &lt;PID&gt;
</code></pre></div><p>In our earlier example, our PID was 6730. Therefore, this would produce:</p>
<pre><code>$ top -H -p 6730
top - 05:38:05 up 13 min,  1 user,  load average: 0.00, 0.05, 0.05
Tasks:  32 total,   0 running,  32 sleeping,   0 stopped,   0 zombie
Cpu(s):  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   1020184k total,   515940k used,   504244k free,    17932k buffers
Swap:        0k total,        0k used,        0k free,   336520k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 6739 ec2-user  20   0 2246m 110m  13m S  0.3 11.1   0:00.24 java
 6730 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6731 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:01.50 java
 6732 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:01.07 java
 6733 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6734 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6735 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6736 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:07.33 java
 6737 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:01.69 java
 6738 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
</code></pre><p>To make a simple standard capture of native threads for diagnostic purposes, you can do the following:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">top -b -n3 -H -p &lt;PID&gt;
</code></pre></div><p>This will capture thread iterations of <code>top</code> by capturing threads of the parent process ID. You can then pipe it to a file.</p>
<p>Example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">top -b -n3 -H -p <span style="color:#0000cf;font-weight:bold">6730</span> &gt; jvm_native_threads.log
</code></pre></div><h2 id="thread-dump">Thread Dump</h2>
<p>To capture a thread dump of the JVM, there are many tools that can achieve this. You can do this over JMX remotely, sending an OS signal (<code>kill -3</code>), or just form the command line (<code>jstack</code> or <code>jcmd</code>). To keep it simple, we will just use <code>jcmd</code> as we will use it later for other diagnostic commands.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jcmd &lt;PID&gt; Thread.print
</code></pre></div><p>:bulb: You need to be the same OS user when invoking the command as the target JVM.</p>
<p>So, using our earlier example, this would be:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jcmd <span style="color:#0000cf;font-weight:bold">6730</span> Thread.print
</code></pre></div><p>However, correlating a thread dump to the native thread state requires a minor translation. In your thread dump, the native thread identifier is in hexadecimal, while the native thread identifiers from <code>top</code> are in decimal. Therefore, if you notice a thread spiking in the <code>top</code> view, you would then want to understand what cod it is correlating to. You can do this simply from the command line via:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;%x\n&#34;</span> &lt;Decimal Thread ID&gt;
</code></pre></div><p>Example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;%x\n&#34;</span> <span style="color:#0000cf;font-weight:bold">6736</span>
1a50
$
</code></pre></div><p>I can then cross reference this thread to my thread dump via the <code>nid</code> (native thread ID) field:</p>
<pre><code>&quot;C2 CompilerThread0&quot; #5 daemon prio=9 os_prio=0 tid=0x00007efda40d4000 nid=0x1a50 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE
</code></pre><p>An alternative tool <a href="https://fastthread.io/"><code>fastthread.io</code></a> also has a blog on other ways to capture a <a href="https://blog.fastthread.io/2016/06/06/how-to-take-thread-dumps-7-options/">thread dump</a></p>
<h2 id="jcmd-perfcounter">jcmd PerfCounter</h2>
<p>A very simple and quick collection of stats on a JVM can be collected via:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jcmd &lt;PID&gt; PerfCounter.print
</code></pre></div><p>Generally the information in this file may or may not indicate the actual problem, but can provide more context in a concise text file of what all has occurred in the life of that JVM. One simple set of counters related to threads are:</p>
<pre><code>java.threads.daemon=20
java.threads.live=26
java.threads.livePeak=38
java.threads.started=697
</code></pre><h2 id="strace">strace</h2>
<p>In some rare cases, you may need to figure out what system calls your JVM is doing. One way to do this on several flavors of Linux, is to use <code>strace</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">strace -f -v -p &lt;PID&gt;
</code></pre></div><p>Example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">strace -f -v -p <span style="color:#0000cf;font-weight:bold">6730</span>
</code></pre></div><p>Example output:</p>
<pre><code>[pid  6741] futex(0x7efda4587228, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;
[pid  6740] write(1, &quot;DEBUG [2015-06-24 05:50:34,727] &quot;..., 168 &lt;unfinished ...&gt;
[pid  6830] gettimeofday( &lt;unfinished ...&gt;
</code></pre><p>From the <code>write</code> call, we can see it is tied to the thread ID 6740. If we translate it to <code>x1a54</code>, which is then tied to this logging thread in the JVM.</p>
<pre><code>&quot;AsyncAppender-Worker-Thread-1&quot; #9 daemon prio=5 os_prio=0 tid=0x00007efda44d1800 nid=0x1a54 waiting on condition [0x00007efd941f0000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &lt;0x00000000f5d38d20&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
</code></pre><p>You will notice that the system calls are quite noisy with the JVM, but this type of troubleshooting can greatly help when the JVM is getting &ldquo;hung&rdquo; or hitting limits by the OS and it isn&rsquo;t clear from the exception that you are seeing what it is getting restricted on.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9a22b492f19ba508a502052a88896ceb">2 - Java Mission Control &amp; Flight Recorder</h1>
    <div class="lead">Initial look at the JVM from its native perspective.</div>
	<p>In this workshop, we will be getting more familiar with using Java Mission Control and the Flight Recorder. As we have been running our service, we want to gather more insight of the code in the service by running series of simple tests and measuring the service.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-bc241cfaf9ff21a46f29fd6eb5c89ce6">2.1 - Introduction</h1>
    <div class="lead">Introduction into Java Mission Control with Flight Recorder</div>
	<h2 id="java-flight-recorder">Java Flight Recorder</h2>
<p>The Java Flight Recorder (JFR) is a very low overhead profiling and diagnostics tool. It was inherited from the JRockit JVM, and it is now offered as part of the HotSpot JVM. It is designed to be &ldquo;black box&rdquo; data recorder of the the run-time, which can be used in production environments, making it an attractive tool for profiling code since it has low overhead on the JVM.</p>
<p>To enable the Flight Recorder on the JVM, the following options need to be included on the JVM:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-XX:+UnlockCommercialFeatures -XX:+FlightRecorder
</code></pre></div><p>:heavy_exclamation_mark: Notice that you have to include <code>-XX:+UnlockCommercialFeatures</code> first in the options listing. This is because using Flight Recorder is a feature that requires additional licensing when used in production environments. One of the following licenses is required in order to utilize this in a production environment.</p>
<ul>
<li>Oracle Java SE Advanced</li>
<li>Oracle Java SE Suite</li>
</ul>
<p>However, you may use this in non-production environments without additional licensing.</p>
<h3 id="higher-fidelity-on-method-profiling">Higher Fidelity on Method Profiling</h3>
<p>To get better fidelity on method profiling, include the following options which will enable the compiler to include additional metadata on non-safe code points. This is helpful, as sometimes the metadata will not fully resolve to the correct line in the code.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints
</code></pre></div><h2 id="java-mission-control">Java Mission Control</h2>
<p>We will be using Java Mission Control <em>(included in Oracle JDK 7u40)</em> to monitor and evaluate the Java flight recordings. To start up  Java Mission Control, simply executing the following in your console:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmc
</code></pre></div><p>:bulb: In order to be able to invoke <code>jmc</code> (Java Mission Control) from your console, it assumes <code>$JAVA_HOME/bin</code> is on your <code>$PATH</code>. If it is not included, go ahead and update your profile to include this so you can easily invoke <code>jmc</code> from your terminal.</p>
<h2 id="start-service-with-jfr">Start Service with JFR</h2>
<p>Let&rsquo;s start profiling our service. Start the service up by enabling JFR:</p>
<h3 id="start-from-the-console">Start from the console</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># Note, if you are running this server from a different folder, consider changing the SERVER_HOME</span>
<span style="color:#000">SERVER_HOME</span><span style="color:#ce5c00;font-weight:bold">=</span>java-perf-workshop-server/target
java -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints -jar <span style="color:#000">$SERVER_HOME</span>/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml
</code></pre></div><p>:bulb: Starting with Java Mission Control 5.5 <em>(included in Oracle Java 8u40)</em>, you no longer have to enable JFR prior to capturing the recording (it will dynamically enable it, after prompting about it).</p>
<h2 id="start-flight-recording-from-jmc">Start Flight Recording from JMC</h2>
<p>From Java Mission Control (JMC), you can start a flight recording by right-clicking the JVM from the <strong>JVM Browser</strong> view and selecting <strong>Start Flight Recording&hellip;</strong></p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_start_flight_recorder.png" alt="jmc_start"></p>
<p>This will open a window where you apply some settings for the recording. First select that you want this to be a <strong>Continuous recording</strong> and for Event settings, we will import a template to get some consistent settings for profiling. Within the <strong>Template Manager</strong>, select <strong>Import Files&hellip;</strong> and import the <code>profile.jfc</code> included in this folder. It should appear as <em>Java Performance Workshop Profile</em>. Select this as the <strong>Event Settings</strong> and then click on <strong>Finish</strong>.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_start_flight_recorder_wizard.png" alt="jmc_started"></p>
<p>Once your flight recording is being captured in a <em>Continuous</em> recording, it will show a ∞.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_flight_recorder_started.png" alt="jmc_started"></p>
<p>:bulb: You can see the JFR templates (continuous / profile) which are shipped as part of the JRE in: <code>$JAVA_HOME/jre/lib/jfr</code>. These become helpful if you are wanting to compare your settings to some of the standard ones.</p>
<h2 id="generate-http-traffic-on-service">Generate HTTP traffic on service</h2>
<p>We will want to generate some traffic on the service to measure some general characteristics of the service:</p>
<ul>
<li>Throughput (requests per second)</li>
<li>Response time</li>
<li>Trend of response time over time</li>
</ul>
<p>By generating traffic on service, this gives us baseline activity in the JVM to start evaluating the flight recording. For the purpose of this workshop, we will utilize <a href="http://httpd.apache.org/docs/2.2/programs/ab.html">Apache Benchmark</a> to generate traffic on the service.</p>
<h3 id="basic-test">Basic test</h3>
<p>This service under test, is a simple web service which provides results based on a search API. When interacting with the service, you can simply supply a HTTP GET on the <em>search</em> resource with a query parameter (&lsquo;q&rsquo;) with the term that you are searching for. It will then return KCDC&rsquo;s 2015 sessions that contain that term. Example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#4e9a06">&#34;http://localhost:8080/search?q=jvm&#34;</span>
<span style="color:#ce5c00;font-weight:bold">{</span>
  <span style="color:#4e9a06">&#34;results&#34;</span> : <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#4e9a06">&#34;title&#34;</span> : <span style="color:#4e9a06">&#34;Concurrency Options on the JVM&#34;</span>,
    <span style="color:#4e9a06">&#34;presenter&#34;</span> : <span style="color:#4e9a06">&#34;Jessica Kerr&#34;</span>,
    <span style="color:#4e9a06">&#34;sessionType&#34;</span> : <span style="color:#4e9a06">&#34;Regular Session&#34;</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#4e9a06">&#34;title&#34;</span> : <span style="color:#4e9a06">&#34;Exploring the Actor Model with Akka.NET&#34;</span>,
    <span style="color:#4e9a06">&#34;presenter&#34;</span> : <span style="color:#4e9a06">&#34;Robert Macdonald Smith&#34;</span>,
    <span style="color:#4e9a06">&#34;sessionType&#34;</span> : <span style="color:#4e9a06">&#34;Regular Session&#34;</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#4e9a06">&#34;title&#34;</span> : <span style="color:#4e9a06">&#34;What&#39;s in your JVM?&#34;</span>,
    <span style="color:#4e9a06">&#34;presenter&#34;</span> : <span style="color:#4e9a06">&#34;Carl Chesser&#34;</span>,
    <span style="color:#4e9a06">&#34;sessionType&#34;</span> : <span style="color:#4e9a06">&#34;4-Hour Workshop&#34;</span>
  <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="using-apache-benchmark">Using Apache Benchmark</h3>
<p>From the console, we will execute the following to generate traffic against our service. Note, we will use a very basic search of just &ldquo;a&rdquo;, since this will generate more results.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ab -n <span style="color:#0000cf;font-weight:bold">1000</span> -c <span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#4e9a06">&#34;http://localhost:8080/search?q=a&#34;</span>
</code></pre></div><h3 id="using-loadtest">Using loadtest</h3>
<p>An alternative to Apache Benchmark, is <a href="https://github.com/alexfernandez/loadtest">loadtest</a> (a node.js equivalent). To install:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo npm install -g loadtest
</code></pre></div><p>Then you can execute similarly:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">loadtest -n <span style="color:#0000cf;font-weight:bold">1000</span> -c <span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#4e9a06">&#34;http://localhost:8080/search?q=a&#34;</span>
</code></pre></div><h3 id="using-gatling">Using gatling</h3>
<p>Alternatively, you can use <a href="https://gatling.io/">gatling</a> (a performance library with a scala dsl ).</p>
<p>This should launch the <code>WorkshopSimulation</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> mvn -f java-perf-workshop-tester/ gatling:test
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mvn gatling:test
</code></pre></div><p>Sample output while running:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ce5c00;font-weight:bold">[</span>~/java-perf-workshop/java-perf-workshop-tester<span style="color:#ce5c00;font-weight:bold">]</span>$ mvn gatling:test
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> Scanning <span style="color:#204a87;font-weight:bold">for</span> projects...
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> ------------------------------------------------------------------------
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> Building java-perf-workshop-tester 1.1.0-SNAPSHOT
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> ------------------------------------------------------------------------
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span>
<span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> --- gatling-maven-plugin:2.2.4:test <span style="color:#ce5c00;font-weight:bold">(</span>default-cli<span style="color:#ce5c00;font-weight:bold">)</span> @ java-perf-workshop-tester ---
19:12:16,662 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.LoggerContext<span style="color:#ce5c00;font-weight:bold">[</span>default<span style="color:#ce5c00;font-weight:bold">]</span> - Could NOT find resource <span style="color:#ce5c00;font-weight:bold">[</span>logback-test.xml<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,663 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.LoggerContext<span style="color:#ce5c00;font-weight:bold">[</span>default<span style="color:#ce5c00;font-weight:bold">]</span> - Could NOT find resource <span style="color:#ce5c00;font-weight:bold">[</span>logback.groovy<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,663 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.LoggerContext<span style="color:#ce5c00;font-weight:bold">[</span>default<span style="color:#ce5c00;font-weight:bold">]</span> - Found resource <span style="color:#ce5c00;font-weight:bold">[</span>logback.xml<span style="color:#ce5c00;font-weight:bold">]</span> at <span style="color:#ce5c00;font-weight:bold">[</span>file:/J:/Workspaces/java-perf-workshop/java-perf-workshop-tester/target/test-classes/logback.xml<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,663 <span style="color:#000;font-weight:bold">|</span>-WARN in ch.qos.logback.classic.LoggerContext<span style="color:#ce5c00;font-weight:bold">[</span>default<span style="color:#ce5c00;font-weight:bold">]</span> - Resource <span style="color:#ce5c00;font-weight:bold">[</span>logback.xml<span style="color:#ce5c00;font-weight:bold">]</span> occurs multiple <span style="color:#204a87">times</span> on the classpath.
19:12:16,663 <span style="color:#000;font-weight:bold">|</span>-WARN in ch.qos.logback.classic.LoggerContext<span style="color:#ce5c00;font-weight:bold">[</span>default<span style="color:#ce5c00;font-weight:bold">]</span> - Resource <span style="color:#ce5c00;font-weight:bold">[</span>logback.xml<span style="color:#ce5c00;font-weight:bold">]</span> occurs at <span style="color:#ce5c00;font-weight:bold">[</span>file:/J:/Workspaces/java-perf-workshop/java-perf-workshop-tester/target/test-classes/logback.xml<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,663 <span style="color:#000;font-weight:bold">|</span>-WARN in ch.qos.logback.classic.LoggerContext<span style="color:#ce5c00;font-weight:bold">[</span>default<span style="color:#ce5c00;font-weight:bold">]</span> - Resource <span style="color:#ce5c00;font-weight:bold">[</span>logback.xml<span style="color:#ce5c00;font-weight:bold">]</span> occurs at <span style="color:#ce5c00;font-weight:bold">[</span>jar:file:/C:/Users/JMonterrubio/.m2/repository/io/gatling/gatling-maven-plugin/2.2.4/gatling-maven-plugin-2.2.4.jar!/logback.xml<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,727 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.joran.action.ConfigurationAction - debug attribute not <span style="color:#204a87">set</span>
19:12:16,731 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.core.joran.action.AppenderAction - About to instantiate appender of <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">[</span>ch.qos.logback.core.ConsoleAppender<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,737 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.core.joran.action.AppenderAction - Naming appender as <span style="color:#ce5c00;font-weight:bold">[</span>CONSOLE<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,742 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.core.joran.action.NestedComplexPropertyIA - Assuming default <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">[</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">[</span>encoder<span style="color:#ce5c00;font-weight:bold">]</span> property
19:12:16,781 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.joran.action.RootLoggerAction - Setting level of ROOT logger to WARN
19:12:16,782 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.core.joran.action.AppenderRefAction - Attaching appender named <span style="color:#ce5c00;font-weight:bold">[</span>CONSOLE<span style="color:#ce5c00;font-weight:bold">]</span> to Logger<span style="color:#ce5c00;font-weight:bold">[</span>ROOT<span style="color:#ce5c00;font-weight:bold">]</span>
19:12:16,782 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.joran.action.ConfigurationAction - End of configuration.
19:12:16,783 <span style="color:#000;font-weight:bold">|</span>-INFO in ch.qos.logback.classic.joran.JoranConfigurator@7a0ac6e3 - Registering current configuration as safe fallback point

Simulation cchesser.javaperf.workshop.WorkshopSimulation started...
</code></pre></div><h2 id="stop-flight-recorder">Stop Flight Recorder</h2>
<p>After you have played traffic through the service, you can then stop your flight recording from JMC.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_flight_recorder_stop.png" alt="jmc_stop"></p>
<p>Then dump the whole recording.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_flight_recorder_dump.png" alt="jmc_dump"></p>
<h2 id="the-flight-recording">The Flight Recording</h2>
<p>From a Java Flight Recording, there are several categories of information you can view from JMC:</p>
<ul>
<li><strong>Memory</strong>: View memory utilization and garbage collection costs.</li>
<li><strong>Code</strong>: View profiling of your code to identify <em>hot spots</em> in your code base. Also, you can get additional insight to exceptions thrown, compilation costs, and class loading.</li>
<li><strong>Threads</strong>: View series of thread dumps, <em>hot</em> threads, latency events, and locking situations causing contention.</li>
<li><strong>I/O</strong>: View general I/O (file / network) costs that were occurring within your code.</li>
<li><strong>System</strong>: Get a general context of the run-time environment of the JVM.</li>
<li><strong>Events</strong>: View a full detailed log of the events within the JVM.</li>
</ul>
<h3 id="code">Code</h3>
<p>Our first walkthrough of the Flight Recording will begin with the <strong>Code</strong> view to give context of where we might be spending time with our code.</p>
<p>When you first open the <strong>Code</strong> tab, you will be brought to the <strong>Overview</strong> sub tab. This will give you a breakdown of where you are spending your time by code package and classes.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_code_overview.png" alt="JMC code overview"></p>
<p>To go deeper into these details, go into the <strong>Hot Methods</strong> sub tab. From here you can expand down to the method which is consuming most of your time.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_code_hot_methods.png" alt="JMC code hot methods"></p>
<p>You can also zoom into the timeline to scope it to a spike of events. This can be done on most view in Java Mission Control. In this case, we will zoom into a 847 ms interval:</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_code_hot_methods_scoped.png" alt="JMC code hot methods"></p>
<p>Another helpful means of identify within a method is including the line number. This can be accomplished by right-clicking in the view and going to <strong>Distinguish Frames By</strong>, and then selecting <strong>Line Number</strong>.</p>
<p>:bulb: Generally, you don&rsquo;t need this, as it can be quite apparent by the base method being invoked where the cost is at. Though, it may be helpful to include in some contexts.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_code_hot_methods_line_number.png" alt="JMC code hot methods"></p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_code_hot_methods_with_line.png" alt="JMC code hot methods"></p>
<p>Walk around to look at other areas where you are spending time in your code. In many cases you find that there are very expensive areas of code that you cannot change (as you may not own it), but you can dictate whether or not it should be executed (or executed as frequently.</p>
<p>We will go into more of the different areas of the flight recording in the next lab.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-81ae492cca539f3173a8a08bae892da5">2.2 - Advanced Flight Recorder</h1>
    <div class="lead">Take the next step in learning more with Flight Recorder</div>
	<p>In this workshop we are going to expand what we profiled earlier to all the different areas of the JVM. The JFR has an extensive amount of data which it captures, we will not dive into each of these areas, but hit on a couple more common areas to inspect on your code base.</p>
<h2 id="exceptions">Exceptions</h2>
<p>Go into the <strong>Code</strong> tab, and then navigate to the <strong>Exceptions</strong> sub tab. Here you can get context of what exceptions are thrown, and when. Exceptions are not necessarily a cheap operation, as there are costs in producing the stack trace.</p>
<p>Within this view, there are three sub tabs:</p>
<ul>
<li>Overview: Get counts on exceptions/errors and related stack traces</li>
<li>Exceptions: Get individual instances of exceptions thrown based on the timeline. Includes string messages which may provide additional context.</li>
<li>Errors: Same content as the Exceptions view, but for Errors.</li>
</ul>
<p>Overview:</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_exceptions_overview.png" alt="JMC Exceptions"></p>
<p>Exceptions sub view (filtered down to a specific time interval):</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_exceptions_exception_subtab.png" alt="JMC Exceptions"></p>
<h3 id="follow-ups">Follow-ups</h3>
<ul>
<li>What are the exceptions that are getting generated the most?</li>
<li>What stack traces are the contributor?</li>
<li>Select different intervals of time to filter the listing of what is being presented. Can you see where</li>
</ul>
<h2 id="threads">Threads</h2>
<p>In the <strong>Threads</strong> tab, you can get context to compute and latency events tied to threads. For this we will look a couple of things:</p>
<ul>
<li>Hot Threads</li>
<li>Latencies</li>
</ul>
<p>The <strong>Hot Thread</strong> sub tab view, you can view threads and the related methods that are consuming the most time. As with other views, you can zoom in on spikes of events to see if there is a common effect. Many times this gives you a better context of related resources (by threads of the same pool) that could be getting heavily utilized by a request. This also helps in correlating other facts you may have (like native threads / thread dumps).</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_thread_hot_threads.png" alt="JMC Hot Threads"></p>
<p>The <strong>Latencies</strong> sub tab can help show common areas of your code (organized by thread states) which can cause slowness in your code base that may not be directly tied to a heavy computation task (ex. waiting on a network call). Generally it helps to look at the large contributor (based on total time consumed) and see when and why it is getting invoked (and if that can be minimized).</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_thread_latencies.png" alt="JMC Latencies"></p>
<h3 id="follow-ups-1">Follow-ups</h3>
<ul>
<li>Where are we spending most of our time sleeping? What is causing this?</li>
</ul>
<h2 id="io">I/O</h2>
<p>The <strong>I/O</strong> tab, can provide context of what external resources you are utilizing from you code base, and relate it to other latency events. For the purpose of our workshop service, we are doing network I/O, and therefore will look at the <strong>Socket Read</strong> sub view. From this view you can gain context of what host you are calling, how many times you are calling it, and how much time it is taking.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_io_socket_read.png" alt="JMC IO Socket Read"></p>
<h3 id="follow-ups-2">Follow-ups</h3>
<ul>
<li>What remote services are we interacting with?</li>
<li>How long are we interacting with them and how many invocations?</li>
<li>How many times did we make calls and what threads were tied to those calls?</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6ef11477fa79b0d64946ef4b156240fc">3 - Memory Analysis</h1>
    <div class="lead">Analyzing the JVM heap with available tooling.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b09263a61c61dd500a73a2e9c3ccb14a">3.1 - Memory Heap Analysis</h1>
    <div class="lead">Analyzing the heap of the JVM.</div>
	<p>In this workshop, we are going to do some analysis of the JVM&rsquo;s heap dump.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Java Mission Control (Oracle Java 7u40+)</li>
<li><a href="http://www.eclipse.org/mat/">Eclipse Memory Analyzer</a></li>
</ul>
<h2 id="capture-a-heap-dump">Capture a Heap Dump</h2>
<p>You may be aware by now, there are many different ways of getting data from the JVM. Here are just a few ways to get heap dump of the JVM.</p>
<h3 id="jcmd">jcmd</h3>
<p>With <code>jcmd</code>, you have the ability to invoke the <code>GC.heap_dump</code> command. This requires that you
are running as the same OS user as the target JVM process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jcmd &lt;PID&gt; GC.heap_dump my_little_heap_dump.hprof
</code></pre></div><p><strong>Note:</strong> If a full path is not specified, the heap_dump will be created relative to the location from where the process was started (when generated with jcmd)</p>
<h3 id="jmap">jmap</h3>
<p>A more traditional approach is using <code>jmap</code> and invoking the command on the target process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmap -dump:format<span style="color:#ce5c00;font-weight:bold">=</span>b,file<span style="color:#ce5c00;font-weight:bold">=</span>my_little_heap_dump.hprof &lt;PID&gt;
</code></pre></div><h3 id="core-dump">Core Dump</h3>
<p>You can also use <code>jmap</code> to extract a heap dump from a core dump on the process:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo gdb --pid<span style="color:#ce5c00;font-weight:bold">=</span>&lt;PID&gt;
gcore /tmp/jvm.core
detach
quit
jmap -dump:format<span style="color:#ce5c00;font-weight:bold">=</span>b,file<span style="color:#ce5c00;font-weight:bold">=</span>my_little_heap_dump.hprof /usr/bin/java /tmp/jvm.core

</code></pre></div><p>:bulb: Capturing a heap dump from a core dump on Java 8, you may run into this issue:
<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8073606">JDK-8073606</a>.</p>
<h3 id="hotspot-diagnostic-mbean">HotSpot Diagnostic MBean</h3>
<p>You can capture a heap dump by invoking a diagnostic MBean which is included in the Oracle JDK. You can do so by opening your favorite MBean browser (ex. <code>jconsole</code>, <code>jmc</code>) and invoke
the <code>com.sun.management.HotSpotDiagnostic</code>. The arguments are:</p>
<ul>
<li>Filename of the heap dump that will be created. :bulb: Note, it will be created with file ownership of the hosting JVM process.</li>
<li>Indicator to dump all live object (true will dump <strong>only live</strong> objects)</li>
</ul>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/hotspot_diag_mbean.png" alt="hotspot_diag"></p>
<h2 id="analyze-the-heap-dump">Analyze the Heap Dump</h2>
<p>As we had in capturing a heap dump, there are many different tools at looking at a heap dump.
We will go through three common tools in which we can do some analysis of a heap dump. All of
which are free. :smiley:</p>
<h3 id="visualvm">VisualVM</h3>
<p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/visualvm/">VisualVM</a> is a tool which is part of Oracle&rsquo;s JDK (has been since Java 6). This tool was spawned from the <a href="https://profiler.netbeans.org/">Netbeans Profiler</a>, and it has some helpful tools to inspect a heap dump.</p>
<p>To load the heap dump in VisualVM, you will just go to <strong>File</strong> -&gt; <strong>Load&hellip;</strong> and specify the
<strong>File Format</strong> to be <strong>Heap Dumps&hellip;</strong>. Once it is loaded, a view will then be presented with
the following sections:</p>
<ul>
<li>Summary</li>
<li>Classes</li>
<li>Instances</li>
<li>OQL Console</li>
</ul>
<p>For the purpose of the workshop we are only going to utilize the <strong>OQL Console</strong> to construct
queries on the heap. There are other options in VisualVM which can give you context about your
heap, but I feel there are other better tools we will touch on later. The attractive feature
I like with VisualVM is that its <strong>OQL Console</strong> allows you to write Javascript code to query
objects, which you can then do other functions on that data.</p>
<h4 id="oql-console">OQL Console</h4>
<p>From the <strong>OQL Console</strong>, we will issue queries and then allow you to further play around with the language.</p>
<p>Query for Thread objects which are daemons (you can get context of Threads, since they
are objects in your heap too):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">select</span> <span style="color:#000">t</span> <span style="color:#000">from</span> <span style="color:#000">java</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lang</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Thread</span> <span style="color:#000">t</span> <span style="color:#000">where</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">daemon</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><p>These basic results which are returned, are essentially hyperlinks, that you can then click
and begin diving into the instance state.</p>
<p>Query for Thread objects (similar to last query), but return multiple attributes as JSON:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">select</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thread_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tid</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">from</span> <span style="color:#000">java</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lang</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Thread</span> <span style="color:#000">t</span>
<span style="color:#000">where</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">daemon</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><p>Query which includes a Javascript function to filter results by looking at all the ConferenceSession
objects, and only report the ones which have <em>tags</em>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Take that previous query and further expand it to list it in JSON with the number of tags:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">),</span> 
 <span style="color:#4e9a06">&#39;{ conference: it, tags: it.tags.size }&#39;</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>We can further expand this to sort the results, descending by number of tags, and list the tags in the results:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">),</span> 
 <span style="color:#4e9a06">&#39;{ conference: it, tag_count: it.tags.size, tags: toArray(it.tags.elementData) }&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#39;rhs.tag_count - lhs.tag_count&#39;</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Reference: <a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/visualvm/visualvm.java.net.backup/master/www/oqlhelp.html">VisualVM OQL Help</a></p>
<p>:bulb: Note, the OQL which you use between this tool (and others), isn&rsquo;t necessarily <em>standard</em>, and therefore cannot be used between tooling without issues. VisualVM gives you
the ability to leverage Javascript, which is unique to other tools supporting heap dump analysis.</p>
<h3 id="java-mission-control-joverflow-plugin">Java Mission Control: JOverflow Plugin</h3>
<p>With <a href="http://www.oracle.com/technetwork/java/javaseproducts/mission-control/java-mission-control-1998576.html">Java Mission Control</a>, there is an ability to add plugins, one of which,
is the JOverflow plugin. You can install it by going to <strong>Help</strong> and select <strong>Install New Software&hellip;</strong>, and then select the <strong>JOverflow Heap Analyzer</strong>.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_overflow_install.png" alt="joverflow"></p>
<p>Once this is installed, when you open a <code>.hprof</code> file, JOverflow will be loaded. Also, it
add a context menu selection to <strong>Dump Heap</strong> of JVMs from the JVM Browser.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_dump_heap.png" alt="joverflow dump heap"></p>
<p>When you open a heap dump, an initial analysis is completed which lists a large range of anti-patterns and things that
can be improved in relation to the memory you utilize.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_joverflow_initial.png" alt="joverflow initial"></p>
<h4 id="anti-patterns">Anti-patterns</h4>
<p>Here is a listing of some the patterns that JOverflow identifies:</p>
<ul>
<li><strong>Empty Unused Collections</strong>: Empty collection, where modification <code>count == 0</code>.</li>
<li><strong>Empty Used Collections</strong>: Empty collection, where modification <code>count != 0</code>.</li>
<li><strong>Small Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Small is considered: size &lt;= default (ex. 16 for HashMap).</li>
<li><strong>Large Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Large is considered: Size &gt; default.</li>
<li><strong>Boxed</strong>: Contains boxed Numbers (ex. java.lang.Integer). Each of these boxed
number has overhead as compared to their primitive counterpart due to object references.</li>
<li><strong>Small Collections</strong>: Collections with 1 to 4 elements. There are fixed costs of collections, which may lend this
set of data better hosted in an array vs. a full Java collection type.</li>
<li><strong>Vertical Bar Collections</strong>: Collection which is a list of lists, where the outer collection
is large, and it&rsquo;s elements are all small collections (ex. List(1000) of List(100))</li>
<li><strong>Zero Size Arrays</strong>: Array where length == 0 (still consumers 12 - 16 bytes).</li>
<li><strong>Vertical Bar Arrays</strong>: Similar to <em>Vertical Bar Collections</em>, but for arrays.</li>
<li><strong>Sparse Arrays</strong>: Less than half of the elements are not null.</li>
<li><strong>Long Zero Tail Arrays</strong>: Ends with a consecutive series of zeros, where the tail length is &gt;= size / 2.</li>
<li><strong>Empty Arrays</strong>: Only null elements.</li>
<li><strong>Duplicate Arrays</strong>: Where an array contents are the same in another instance, but they are separate array instances.</li>
<li><strong>Duplicate Strings</strong>: Same as <em>Duplicate Array</em>, where <code>string1.equals(string2)</code> and <code>string1 != string2</code>.</li>
</ul>
<p>Reference: <a href="https://www.youtube.com/watch?v=b-mv9iWY8kw">JOverflow: Advanced Heap Analysis in Java Mission Control</a></p>
<h4 id="filtering">Filtering</h4>
<p>As you play with JOverflow, once you click on something, it will begin filtering down your content. If you wish to reduce
down to code that you may own, you can start doing a package filter on the ancestor section. In this example, I want to see duplicate strings for code under <code>cchesser</code>. In this case, I can see that our workshop service has several duplicate
strings (as this content is replicated on each object):</p>
<ul>
<li>Regular Session</li>
<li>4-Hour Workshop</li>
<li>8-Hour Workshop</li>
</ul>
<p>However, the number of instances / overhead is extremely low (since this is a small service), it gives you visibility of areas that you could optimize.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_overflow_filter_to_ancestor.png" alt="joverflow filter"></p>
<h3 id="eclipse-memory-analyzer">Eclipse Memory Analyzer</h3>
<p><a href="https://eclipse.org/mat/">Eclipse Memory Analyzer</a> is a fairly mature tool on analyzing heap dumps. It is a rich tool that includes the abilities to do OQL queries on the heap, general reporting on anti-patterns, and helpful common views (like the dominator tree). Eclipse Memory Analyzer tool is a separate install which can be a standalone install, or it can run as a plugin within Eclipse. First, install the tool if you haven&rsquo;t already via their <a href="https://eclipse.org/mat/downloads.php">downloads page</a>.</p>
<p>After you have it installed, go to <strong>File</strong> and then <strong>Open Heap Dump&hellip;</strong> and specify the <code>hprof</code> file that you wish to analyze.</p>
<p>:bulb: When Eclipse Memory Analyzer loads your <code>hprof</code> file, it will create many other index files to assist in optimally analyzing and navigating through your heap dump. It may make it easier to isolate your <code>prof</code> file in its own directory prior to opening it, based on the secondary files which are created. You can always just delete these files within Eclipse Memory Analyzer by opening the <strong>Heap Dump History</strong> window, right-clicking the <code>hprof</code> which was previously loaded, and selecting <strong>Delete Index Files</strong>. Example listing of index files which get generated by suffix:</p>
<ul>
<li><code>.domIn.index</code></li>
<li><code>.domOut.index</code></li>
<li><code>.index</code></li>
<li><code>.o2ret.index</code></li>
<li><code>.a2s.index</code></li>
<li><code>.idx.index</code></li>
<li><code>.inbound.index</code></li>
<li><code>.o2c.index</code></li>
<li><code>.o2hprof.index</code></li>
<li><code>.outbound.index</code></li>
<li><code>.threads</code></li>
</ul>
<h4 id="dominator-tree">Dominator Tree</h4>
<p>A common first area to look at your heap within Eclipse Memory Analyzer is the dominator tree. From the dominator tree, you can organize by the retained heap size, and then begin drilling down the tree to see the contributors to the largest GC roots.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_dominator_tree.png" alt="MAT Dominator Tree"></p>
<h4 id="histogram">Histogram</h4>
<p>The histogram gives you a quick listing of all the top consumers by type. Typically this is going to provide context of the large consumers based on their &ldquo;lower-level&rdquo; types. For example, <code>char[]</code> is a common large contributor, which then will be followed by <code>String</code> which is a type that is predominately weighted by the size of the <code>char[]</code>.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_histogram.png" alt="MAT Thread Overview"></p>
<h4 id="thread-overview">Thread Overview</h4>
<p>The thread overview is a helpful view when you are looking at contributors based on the execution of code. For example, if you have a JVM which has thrown an <code>OutOfMemoryError</code>, you can tell if some type of request caused a massive spike which caused the exhaustion of memory, or if the requests may have not been abnormal, there just wasn&rsquo;t sufficient space to support the request.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_thread_overview.png" alt="MAT Thread Overview"></p>
<h4 id="oql">OQL</h4>
<p>Another strong feature of Eclipse Memory Analyzer is the OQL studio to execute queries to do lookup on objects in your heap.</p>
<p>Lookup our <code>ConferenceSession</code> class type:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#ce5c00;font-weight:bold">*</span>
<span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span>
</code></pre></div><p>:bulb: To execute the query, you click on the red exclamation mark (:exclamation:). Alternatively, you can press <code>CTRL+Enter</code> on Windows or <code>Command+Enter</code> on macOS.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_oql_studio.png" alt="MAT OQL"></p>
<p>By returning the raw type back, you can expand each one to further look at the contents of the object. If you wanted to just report the object with its <code>title</code> attribute and the object&rsquo;s retained sized, you could do this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">retainedHeapSize</span> 
<span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span> <span style="color:#204a87;font-weight:bold">c</span> 
</code></pre></div><p>Now, you could then filter this by including a <code>WHERE</code> clause, where you can filter it by
the title or the abstract:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">retainedHeapSize</span> <span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span> <span style="color:#204a87;font-weight:bold">c</span> 
<span style="color:#204a87;font-weight:bold">WHERE</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">LIKE</span> <span style="color:#4e9a06">&#34;.*(J|j)ava.*&#34;</span> <span style="color:#204a87;font-weight:bold">OR</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abstract</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">LIKE</span> <span style="color:#4e9a06">&#34;.*(J|j)ava.*&#34;</span>
</code></pre></div><p>Reference: <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html">Eclipse Memory Analyzer OQL Syntax</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6512c461f5f3bf1ba4ced486f736874">3.2 - Garbage Collections</h1>
    <div class="lead">Analyzing garbage collections of the JVM</div>
	<h1 id="part-5-garbage-collections">Part 5: Garbage Collections</h1>
<p>In this workshop, we are going to do some analysis on the JVM in regards to it&rsquo;s garbage collection (GC)
cycles.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li><a href="https://www.r-project.org/">R environment</a> <em>(If you want to try parsing some of the logs)</em></li>
</ul>
<h2 id="garbage-collection-logs">Garbage Collection Logs</h2>
<p>A key piece to understanding what is happening in terms of GC cycles within your service,
is enabling GC logs. In this section we will go over the JVM options you can enable on your
service and how to interpret those logs.</p>
<h3 id="jvm-options">JVM Options</h3>
<ul>
<li><code>-XX:+PrintGCDetails</code>: Includes more details within your GC log</li>
<li><code>-XX:+PrintGCDateStamps</code>: Have a readable date/time string to correlate events in your log. Without
this option, your GC log will have elapsed time since the JVM was started. This format (which is reported)
in seconds (with millisecond precision), is not easy for someone to quickly correlate when this event was
logged (as you have to infer the time based on when the JVM was started).</li>
<li><code>-Xloggc</code>: Specifies the log file for the garbage collection logs (otherwise will go to stdout).
:bulb: Note: <code>-verbose:gc</code> is NOT necessary when you set <code>Xloggc</code> (it is implied).</li>
<li><code>-XX:+UseGCLogFileRotation</code>: Support rotating your GC log file (you don&rsquo;t want to let this get too
big).</li>
<li><code>-XX:GCLogFileSize</code>: Size of the file for rotation (ex. <code>10M</code>).</li>
<li><code>-XX:NumberOfGCLogFiles</code>: Number of GC log files to maintain (ex. <code>3</code>). :bulb: Note: if you are monitoring
your log file with another solution (like <a href="http://www.splunk.com/">splunk</a> or
<a href="https://www.elastic.co/products/logstash">logstash</a>), you typically don&rsquo;t need to be keeping an inventory of
rolled files around, unless you are concerned about log forwarding failing and want to ensure a given amount
is still capable of being captured from a host.</li>
</ul>
<h3 id="gc-log-formats">GC Log formats</h3>
<p>With different garbage collectors in the JVM, you will get slightly different GC log formats.</p>
<h4 id="parralel-gc">Parralel GC</h4>
<pre><code>2015-09-30T10:57:20.215+0600: 0.847: [GC (Allocation Failure) [PSYoungGen: 65536K-&gt;10748K(76288K)] 65536K-&gt;12607K(251392K), 0.0118637 secs] [Times: user=0.03 sys=0.01, real=0.01 secs]
2015-09-30T10:57:20.556+0600: 1.188: [GC (Metadata GC Threshold) [PSYoungGen: 44312K-&gt;10748K(141824K)] 46171K-&gt;12786K(316928K), 0.0077755 secs] [Times: user=0.03 sys=0.00, real=0.01 secs]
2015-09-30T10:57:20.564+0600: 1.196: [Full GC (Metadata GC Threshold) [PSYoungGen: 10748K-&gt;0K(141824K)] [ParOldGen: 2038K-&gt;10444K(116736K)] 12786K-&gt;10444K(258560K), [Metaspace: 20976K-&gt;20976K(1067008K)], 0.0286381 secs] [Times: user=0.14 sys=0.01, real=0.03 secs]
</code></pre><h4 id="cms">CMS</h4>
<pre><code>2015-09-30T11:11:35.994+0600: 0.838: [GC (Allocation Failure) 0.838: [ParNew: 69952K-&gt;8703K(78656K), 0.0128204 secs] 69952K-&gt;12781K(253440K), 0.0128848 secs] [Times: user=0.04 sys=0.01, real=0.01 secs]
2015-09-30T11:11:38.009+0600: 2.853: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4077K(174784K)] 67493K(253440K), 0.0088311 secs] [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-mark-start]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-mark: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-preclean-start]
2015-09-30T11:11:38.019+0600: 2.863: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
2015-09-30T11:11:38.019+0600: 2.863: [CMS-concurrent-abortable-preclean-start]
 CMS: abort preclean due to time 2015-09-30T11:11:43.074+0600: 7.918: [CMS-concurrent-abortable-preclean: 1.233/5.055 secs] [Times: user=1.23 sys=0.01, real=5.06 secs]
2015-09-30T11:11:43.074+0600: 7.918: [GC (CMS Final Remark) [YG occupancy: 63415 K (78656 K)]7.918: [Rescan (parallel) , 0.0052614 secs]7.924: [weak refs processing, 0.0000337 secs]7.924: [class unloading, 0.0029068 secs]7.927: [scrub symbol table, 0.0025781 secs]7.929: [scrub string table, 0.0002699 secs][1 CMS-remark: 4077K(174784K)] 67493K(253440K), 0.0117740 secs] [Times: user=0.04 sys=0.01, real=0.01 secs]
2015-09-30T11:11:43.086+0600: 7.930: [CMS-concurrent-sweep-start]
2015-09-30T11:11:43.086+0600: 7.930: [CMS-concurrent-sweep: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2015-09-30T11:11:43.087+0600: 7.930: [CMS-concurrent-reset-start]
2015-09-30T11:11:43.110+0600: 7.954: [CMS-concurrent-reset: 0.023/0.023 secs] [Times: user=0.01 sys=0.01, real=0.03 secs]
</code></pre><h4 id="g1">G1</h4>
<pre><code>015-09-30T11:13:03.870+0600: 0.395: [GC pause (G1 Evacuation Pause) (young), 0.0052206 secs]
   [Parallel Time: 1.9 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 395.4, Avg: 395.5, Max: 395.8, Diff: 0.3]
      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.3, Max: 1.1, Diff: 1.1, Sum: 2.0]
      [Update RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
         [Processed Buffers: Min: 0, Avg: 0.0, Max: 0, Diff: 0, Sum: 0]
      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.1, Max: 0.4, Diff: 0.4, Sum: 0.5]
      [Object Copy (ms): Min: 0.7, Avg: 1.4, Max: 1.6, Diff: 0.9, Sum: 11.4]
      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Total (ms): Min: 1.5, Avg: 1.8, Max: 1.8, Diff: 0.3, Sum: 14.2]
      [GC Worker End (ms): Min: 397.3, Avg: 397.3, Max: 397.3, Diff: 0.0]
   [Code Root Fixup: 0.1 ms]
   [Code Root Purge: 0.1 ms]
   [Clear CT: 0.1 ms]
   [Other: 3.0 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.7 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.2 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.0 ms]
   [Eden: 24.0M(24.0M)-&gt;0.0B(39.0M) Survivors: 0.0B-&gt;3072.0K Heap: 24.0M(256.0M)-&gt;5754.5K(256.0M)]
 [Times: user=0.02 sys=0.01, real=0.00 secs]
2015-09-30T11:13:04.343+0600: 0.868: [GC pause (G1 Evacuation Pause) (young), 0.0082908 secs]
   [Parallel Time: 5.1 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 868.3, Avg: 868.4, Max: 868.8, Diff: 0.5]
      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.3, Max: 1.7, Diff: 1.7, Sum: 2.7]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 0.5]
         [Processed Buffers: Min: 0, Avg: 0.4, Max: 1, Diff: 1, Sum: 3]
      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.4, Max: 1.4, Diff: 1.4, Sum: 3.5]
      [Object Copy (ms): Min: 3.2, Avg: 4.0, Max: 4.6, Diff: 1.4, Sum: 32.1]
      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.6]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Total (ms): Min: 4.6, Avg: 4.9, Max: 5.0, Diff: 0.5, Sum: 39.5]
      [GC Worker End (ms): Min: 873.3, Avg: 873.3, Max: 873.4, Diff: 0.0]
   [Code Root Fixup: 0.3 ms]
   [Code Root Purge: 0.1 ms]
   [Clear CT: 0.1 ms]
   [Other: 2.7 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.4 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.1 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.1 ms]
   [Eden: 39.0M(39.0M)-&gt;0.0B(147.0M) Survivors: 3072.0K-&gt;6144.0K Heap: 44.6M(256.0M)-&gt;13.9M(256.0M)]
 [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:13:04.650+0600: 1.176: [GC pause (Metadata GC Threshold) (young) (initial-mark), 0.0090083 secs]
   [Parallel Time: 5.5 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 1175.9, Avg: 1176.0, Max: 1176.0, Diff: 0.1]
      [Ext Root Scanning (ms): Min: 1.1, Avg: 1.2, Max: 1.4, Diff: 0.3, Sum: 9.4]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.2]
         [Processed Buffers: Min: 0, Avg: 1.1, Max: 2, Diff: 2, Sum: 9]
      [Scan RS (ms): Min: 0.1, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.2, Max: 0.5, Diff: 0.5, Sum: 2.0]
      [Object Copy (ms): Min: 3.4, Avg: 3.7, Max: 3.8, Diff: 0.4, Sum: 29.3]
      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.2]
      [GC Worker Total (ms): Min: 5.4, Avg: 5.4, Max: 5.5, Diff: 0.1, Sum: 43.3]
      [GC Worker End (ms): Min: 1181.4, Avg: 1181.4, Max: 1181.4, Diff: 0.0]
   [Code Root Fixup: 0.3 ms]
   [Code Root Purge: 0.0 ms]
   [Clear CT: 0.1 ms]
   [Other: 3.0 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.7 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.1 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.1 ms]
   [Eden: 33.0M(147.0M)-&gt;0.0B(140.0M) Survivors: 6144.0K-&gt;13.0M Heap: 46.9M(256.0M)-&gt;20.9M(256.0M)]
 [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:13:04.660+0600: 1.185: [GC concurrent-root-region-scan-start]
2015-09-30T11:13:04.664+0600: 1.190: [GC concurrent-root-region-scan-end, 0.0046509 secs]
2015-09-30T11:13:04.664+0600: 1.190: [GC concurrent-mark-start]
2015-09-30T11:13:04.665+0600: 1.190: [GC concurrent-mark-end, 0.0007287 secs]
2015-09-30T11:13:04.665+0600: 1.190: [GC remark 1.190: [Finalize Marking, 0.0001736 secs] 1.191: [GC ref-proc, 0.0000411 secs] 1.191: [Unloading, 0.0016740 secs], 0.0020377 secs]
 [Times: user=0.01 sys=0.00, real=0.00 secs]
2015-09-30T11:13:04.667+0600: 1.193: [GC cleanup 21M-&gt;14M(256M), 0.0004254 secs]
 [Times: user=0.01 sys=0.00, real=0.00 secs]
</code></pre><h4 id="type-of-collections">Type of Collections</h4>
<p>A simple rule to watch for on your logs is the prefix of either:</p>
<pre><code>[GC ...      &lt;- Minor GC cycle (young gen)
[Full GC ... &lt;- Full GC cycle
</code></pre><p>(:exclamation:) Explicit GCs can also be identified, which is when something is invoking the <code>System.gc()</code> API. Note, this is not good thing, as
something is forcing a GC cycle to occur, rather than letting the JVM trigger this on its own (what should naturally occur).</p>
<pre><code>2015-09-30T12:23:44.425+0600: 195.699: [GC (System.gc()) [PSYoungGen: 39223K-&gt;3562K(76288K)] 49685K-&gt;14032K(190464K), 0.0047880 secs] [Times: user=0.02 sys=0.00, real=0.01 secs]
2015-09-30T12:23:44.430+0600: 195.704: [Full GC (System.gc()) [PSYoungGen: 3562K-&gt;0K(76288K)] [ParOldGen: 10469K-&gt;9174K(114176K)] 14032K-&gt;9174K(190464K), [Metaspace: 25137K-&gt;25137K(1071104K)], 0.0724521 secs] [Times: user=0.38 sys=0.01, real=0.07 secs]
</code></pre><p>It is generally recommended to use the <code>-XX:+DisableExplicitGC</code> JVM option to disable forceful GC events. This will allow
the JVM to still have garbage collections, but it disables them from being triggered explicitly. The description of this option:</p>
<blockquote>
<p>By default calls to System.gc() are enabled (-XX:-DisableExplicitGC). Use -XX:+DisableExplicitGC to disable calls to System.gc(). Note that the JVM still performs garbage collection when necessary.</p>
</blockquote>
<h3 id="enabling-gc-logging">Enabling GC logging</h3>
<p>With our service, let&rsquo;s go ahead and start it up with GC logging enabled:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># Navigate to the root directory of this project</span>
java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:gc.log -XX:GCLogFileSize<span style="color:#ce5c00;font-weight:bold">=</span>5M -XX:NumberOfGCLogFiles<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span> -jar java-perf-workshop-server/target/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml 
</code></pre></div><h3 id="parsing-the-log">Parsing the log</h3>
<p>For parsing the logs, we are just going to show a simple approach using <a href="https://www.r-project.org/">R</a> to parse the
<code>gc.log</code> that we created. To do this, we will use the <code>stringr</code> package.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic"># Including stringr package for regex</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stringr</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Navigating to where the project is at on my filesystem</span>
<span style="color:#000">setwd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;~/java-perf-workshop&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Read the GC log file in</span>
<span style="color:#000">gc</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">readLines</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;gc.log&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Regex the matches</span>
<span style="color:#000">matches</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">str_match</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(\\d+)K-&gt;(\\d+)K\\((\\d+)K\\),\\s(\\d+.\\d+)\\ssecs.*\\[Times\\: user=(\\d+.\\d+) sys=(\\d+.\\d+), real=(\\d+.\\d+) secs&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Look at what matches, now we want to filter out the NA</span>
<span style="color:#000">matches</span>

<span style="color:#8f5902;font-style:italic"># Filter content out and convert to a data frame</span>
<span style="color:#000">gc.df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">na.omit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">matches[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">stringsAsFactors</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Add a column header to describe fields</span>
<span style="color:#000">colnames</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc.df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HeapUsedBeforeGC_KB&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;HeapUsedAfterGC_KB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HeapCapacity_KB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCPauseTime_Sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCUserTime_Sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCSysTime_Sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCRealTime_Sec&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># List out the contents of the data frame</span>
<span style="color:#000">gc.df</span>
</code></pre></div><p>Example output:</p>
<pre><code>  HeapUsedBeforeGC_KB HeapUsedAfterGC_KB HeapCapacity_KB GCPauseTime_Sec GCUserTime_Sec GCSysTime_Sec GCRealTime_Sec
1               65536              12554          251392       0.0091645           0.03          0.01           0.01
2               45883              12707          316928       0.0092271           0.03          0.01           0.01
</code></pre><p>Reminder on the types of time being collected:</p>
<ul>
<li><code>GCUserTime_Sec</code>: User space time</li>
<li><code>GCSysTime_Sec</code>: Kernel space time (operating system)</li>
<li><code>GCRealTime_Sec</code>: Complete time taken</li>
</ul>
<p>Notice that the <code>GCRealTime_Sec</code> should closely align with the <code>GCPauseTime_Sec</code> value (just rounded up). If you notice that the
<code>GCUserTime_Sec</code> is much larger than the <code>GCRealTime_Sec</code>, you can conclude that multiple threads are executing garbage collection,
as <code>GCUserTime_Sec</code> is just the sum time of all the threads.</p>
<h1 id="gc-easy">GC Easy</h1>
<p>There&rsquo;s an existing tool <a href="http://gceasy.io/">GC Easy</a> which will do GC log parsing and analysis as well.</p>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/cchesser/java-perf-workshop">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 Carl Chesser All Rights Reserved</small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>













<script src="/js/main.min.f820bfc507c3ebefe17f8881ec4ee10013f3b89ad9555a50acf9bb1771e6823f.js" integrity="sha256-&#43;CC/xQfD6&#43;/hf4iB7E7hABPzuJrZVVpQrPm7F3Hmgj8=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
