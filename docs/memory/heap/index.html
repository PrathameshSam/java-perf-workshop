<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.79.1" /><META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Memory Heap Analysis | jvmperf: Java Performance Workshop</title><meta property="og:title" content="Memory Heap Analysis" />
<meta property="og:description" content="Analyzing the heap of the JVM." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jvmperf.net/docs/memory/heap/" />
<meta property="article:modified_time" content="2021-01-18T22:42:19-06:00" /><meta property="og:site_name" content="jvmperf: Java Performance Workshop" />
<meta itemprop="name" content="Memory Heap Analysis">
<meta itemprop="description" content="Analyzing the heap of the JVM.">
<meta itemprop="dateModified" content="2021-01-18T22:42:19-06:00" />
<meta itemprop="wordCount" content="1718">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Memory Heap Analysis"/>
<meta name="twitter:description" content="Analyzing the heap of the JVM."/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-187218497-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/scss/main.min.d365b133824fa7cc9e634c8a9ba97597f3759b03ad3fd78d42c3d136099b4543.css" as="style">
<link href="/scss/main.min.d365b133824fa7cc9e634c8a9ba97597f3759b03ad3fd78d42c3d136099b4543.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>



  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="font-weight-bold"><i class="fas fa-cube"></i>&nbsp;&nbsp;jvmperf</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/docs/" ><span class="active">Workshop</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/cchesser/java-perf-workshop/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.ed1a533175319c1282d3775c2c2bffba.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.ed1a533175319c1282d3775c2c2bffba.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Workshop</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
        
          






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/prereqs/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Prerequisites</a>
  </li>
  <ul>
    <li class="collapse " id="docsprereqs">
      
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/setup/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Setup</a>
  </li>
  <ul>
    <li class="collapse " id="docssetup">
      
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/intro/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Process and Threads</a>
  </li>
  <ul>
    <li class="collapse " id="docsintro">
      
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/jmc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Java Mission Control &amp; Flight Recorder</a>
  </li>
  <ul>
    <li class="collapse " id="docsjmc">
      
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmc_intro_jmc7" href="/docs/jmc/_intro_jmc7/">Introduction</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmcmethod_profiling" href="/docs/jmc/method_profiling/">Method Profiling</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmcexceptions" href="/docs/jmc/exceptions/">Exceptions</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmcthreads" href="/docs/jmc/threads/">Threads</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmcmemory" href="/docs/jmc/memory/">Memory</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmcio_operations" href="/docs/jmc/io_operations/">I/O Operations</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsjmc_references" href="/docs/jmc/_references/">References</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/memory/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Memory Analysis</a>
  </li>
  <ul>
    <li class="collapse show" id="docsmemory">
      
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsmemoryheap" href="/docs/memory/heap/">Memory Heap Analysis</a>
        
      
      
      
        
          
          
          <a class="td-sidebar-link td-sidebar-link__page " id="m-docsmemorygc" href="/docs/memory/gc/">Garbage Collections</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    <a href="https://github.com/cchesser/java-perf-workshop/edit/main/docs/content/docs/memory/heap.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
    <a href="https://github.com/cchesser/java-perf-workshop/new/main/docs/content/docs/memory/heap.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> Create child page</a>
    <a href="https://github.com/cchesser/java-perf-workshop/issues/new?title=Memory%20Heap%20Analysis" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
    

  
  
    <a id="print" href="https://jvmperf.net/docs/memory/_print/"><i class="fa fa-print fa-fw"></i> Print entire section</a>
  
  </div>





<nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#capture-a-heap-dump">Capture a Heap Dump</a>
      <ul>
        <li><a href="#jcmd">jcmd</a></li>
        <li><a href="#jmap">jmap</a></li>
        <li><a href="#core-dump">Core Dump</a></li>
        <li><a href="#hotspot-diagnostic-mbean">HotSpot Diagnostic MBean</a></li>
      </ul>
    </li>
    <li><a href="#analyze-the-heap-dump">Analyze the Heap Dump</a>
      <ul>
        <li><a href="#visualvm">VisualVM</a></li>
        <li><a href="#java-mission-control-joverflow-plugin">Java Mission Control: JOverflow Plugin</a></li>
        <li><a href="#eclipse-memory-analyzer">Eclipse Memory Analyzer</a></li>
      </ul>
    </li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="https://jvmperf.net/docs/">Workshop</a>
</li>




<li class="breadcrumb-item" >
	<a href="https://jvmperf.net/docs/memory/">Memory Analysis</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="https://jvmperf.net/docs/memory/heap/">Memory Heap Analysis</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>Memory Heap Analysis</h1>
    <div class="lead">Analyzing the heap of the JVM.</div>
	
        <p class="reading-time"><i class="fa fa-clock" aria-hidden="true"></i> 9 minute read</p>
           
	<p>In this workshop, we are going to do some analysis of the JVM&rsquo;s heap dump.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Java Mission Control (Oracle Java 7u40+)</li>
<li><a href="http://www.eclipse.org/mat/">Eclipse Memory Analyzer</a></li>
</ul>
<h2 id="capture-a-heap-dump">Capture a Heap Dump</h2>
<p>You may be aware by now, there are many different ways of getting data from the JVM. Here are just a few ways to get heap dump of the JVM.</p>
<h3 id="jcmd">jcmd</h3>
<p>With <code>jcmd</code>, you have the ability to invoke the <code>GC.heap_dump</code> command. This requires that you
are running as the same OS user as the target JVM process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jcmd &lt;PID&gt; GC.heap_dump my_little_heap_dump.hprof
</code></pre></div><p><strong>Note:</strong> If a full path is not specified, the heap_dump will be created relative to the location from where the process was started (when generated with jcmd)</p>
<h3 id="jmap">jmap</h3>
<p>A more traditional approach is using <code>jmap</code> and invoking the command on the target process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmap -dump:format<span style="color:#ce5c00;font-weight:bold">=</span>b,file<span style="color:#ce5c00;font-weight:bold">=</span>my_little_heap_dump.hprof &lt;PID&gt;
</code></pre></div><h3 id="core-dump">Core Dump</h3>
<p>You can also use <code>jmap</code> to extract a heap dump from a core dump on the process:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo gdb --pid<span style="color:#ce5c00;font-weight:bold">=</span>&lt;PID&gt;
gcore /tmp/jvm.core
detach
quit
jmap -dump:format<span style="color:#ce5c00;font-weight:bold">=</span>b,file<span style="color:#ce5c00;font-weight:bold">=</span>my_little_heap_dump.hprof /usr/bin/java /tmp/jvm.core

</code></pre></div><p>💡 Capturing a heap dump from a core dump on Java 8, you may run into this issue:
<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8073606">JDK-8073606</a>.</p>
<h3 id="hotspot-diagnostic-mbean">HotSpot Diagnostic MBean</h3>
<p>You can capture a heap dump by invoking a diagnostic MBean which is included in the Oracle JDK. You can do so by opening your favorite MBean browser (ex. <code>jconsole</code>, <code>jmc</code>) and invoke
the <code>com.sun.management.HotSpotDiagnostic</code>. The arguments are:</p>
<ul>
<li>Filename of the heap dump that will be created. 💡 Note, it will be created with file ownership of the hosting JVM process.</li>
<li>Indicator to dump all live object (true will dump <strong>only live</strong> objects)</li>
</ul>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/hotspot_diag_mbean.png" alt="hotspot_diag"></p>
<h2 id="analyze-the-heap-dump">Analyze the Heap Dump</h2>
<p>As we had in capturing a heap dump, there are many different tools at looking at a heap dump.
We will go through three common tools in which we can do some analysis of a heap dump. All of
which are free. :smiley:</p>
<h3 id="visualvm">VisualVM</h3>
<p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/visualvm/">VisualVM</a> is a tool which is part of Oracle&rsquo;s JDK (has been since Java 6). This tool was spawned from the <a href="https://profiler.netbeans.org/">Netbeans Profiler</a>, and it has some helpful tools to inspect a heap dump.</p>
<p>To load the heap dump in VisualVM, you will just go to <strong>File</strong> -&gt; <strong>Load&hellip;</strong> and specify the
<strong>File Format</strong> to be <strong>Heap Dumps&hellip;</strong>. Once it is loaded, a view will then be presented with
the following sections:</p>
<ul>
<li>Summary</li>
<li>Classes</li>
<li>Instances</li>
<li>OQL Console</li>
</ul>
<p>For the purpose of the workshop we are only going to utilize the <strong>OQL Console</strong> to construct
queries on the heap. There are other options in VisualVM which can give you context about your
heap, but I feel there are other better tools we will touch on later. The attractive feature
I like with VisualVM is that its <strong>OQL Console</strong> allows you to write Javascript code to query
objects, which you can then do other functions on that data.</p>
<h4 id="oql-console">OQL Console</h4>
<p>From the <strong>OQL Console</strong>, we will issue queries and then allow you to further play around with the language.</p>
<p>Query for Thread objects which are daemons (you can get context of Threads, since they
are objects in your heap too):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">select</span> <span style="color:#000">t</span> <span style="color:#000">from</span> <span style="color:#000">java</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lang</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Thread</span> <span style="color:#000">t</span> <span style="color:#000">where</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">daemon</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><p>These basic results which are returned, are essentially hyperlinks, that you can then click
and begin diving into the instance state.</p>
<p>Query for Thread objects (similar to last query), but return multiple attributes as JSON:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">select</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thread_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tid</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">from</span> <span style="color:#000">java</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lang</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Thread</span> <span style="color:#000">t</span>
<span style="color:#000">where</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">daemon</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><p>Query which includes a Javascript function to filter results by looking at all the ConferenceSession
objects, and only report the ones which have <em>tags</em>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Take that previous query and further expand it to list it in JSON with the number of tags:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">),</span> 
 <span style="color:#4e9a06">&#39;{ conference: it, tags: it.tags.size }&#39;</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>We can further expand this to sort the results, descending by number of tags, and list the tags in the results:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">),</span> 
 <span style="color:#4e9a06">&#39;{ conference: it, tag_count: it.tags.size, tags: toArray(it.tags.elementData) }&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#39;rhs.tag_count - lhs.tag_count&#39;</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Reference: <a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/visualvm/visualvm.java.net.backup/master/www/oqlhelp.html">VisualVM OQL Help</a></p>
<p>💡 Note, the OQL which you use between this tool (and others), isn&rsquo;t necessarily <em>standard</em>, and therefore cannot be used between tooling without issues. VisualVM gives you
the ability to leverage Javascript, which is unique to other tools supporting heap dump analysis.</p>
<h3 id="java-mission-control-joverflow-plugin">Java Mission Control: JOverflow Plugin</h3>
<p>With <a href="http://www.oracle.com/technetwork/java/javaseproducts/mission-control/java-mission-control-1998576.html">Java Mission Control</a>, there is an ability to add plugins, one of which,
is the JOverflow plugin. You can install it by going to <strong>Help</strong> and select <strong>Install New Software&hellip;</strong>, and then select the <strong>JOverflow Heap Analyzer</strong>.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_overflow_install.png" alt="joverflow"></p>
<p>Once this is installed, when you open a <code>.hprof</code> file, JOverflow will be loaded. Also, it
add a context menu selection to <strong>Dump Heap</strong> of JVMs from the JVM Browser.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_dump_heap.png" alt="joverflow dump heap"></p>
<p>When you open a heap dump, an initial analysis is completed which lists a large range of anti-patterns and things that
can be improved in relation to the memory you utilize.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_joverflow_initial.png" alt="joverflow initial"></p>
<h4 id="anti-patterns">Anti-patterns</h4>
<p>Here is a listing of some the patterns that JOverflow identifies:</p>
<ul>
<li><strong>Empty Unused Collections</strong>: Empty collection, where modification <code>count == 0</code>.</li>
<li><strong>Empty Used Collections</strong>: Empty collection, where modification <code>count != 0</code>.</li>
<li><strong>Small Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Small is considered: size &lt;= default (ex. 16 for HashMap).</li>
<li><strong>Large Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Large is considered: Size &gt; default.</li>
<li><strong>Boxed</strong>: Contains boxed Numbers (ex. java.lang.Integer). Each of these boxed
number has overhead as compared to their primitive counterpart due to object references.</li>
<li><strong>Small Collections</strong>: Collections with 1 to 4 elements. There are fixed costs of collections, which may lend this
set of data better hosted in an array vs. a full Java collection type.</li>
<li><strong>Vertical Bar Collections</strong>: Collection which is a list of lists, where the outer collection
is large, and it&rsquo;s elements are all small collections (ex. List(1000) of List(100))</li>
<li><strong>Zero Size Arrays</strong>: Array where length == 0 (still consumers 12 - 16 bytes).</li>
<li><strong>Vertical Bar Arrays</strong>: Similar to <em>Vertical Bar Collections</em>, but for arrays.</li>
<li><strong>Sparse Arrays</strong>: Less than half of the elements are not null.</li>
<li><strong>Long Zero Tail Arrays</strong>: Ends with a consecutive series of zeros, where the tail length is &gt;= size / 2.</li>
<li><strong>Empty Arrays</strong>: Only null elements.</li>
<li><strong>Duplicate Arrays</strong>: Where an array contents are the same in another instance, but they are separate array instances.</li>
<li><strong>Duplicate Strings</strong>: Same as <em>Duplicate Array</em>, where <code>string1.equals(string2)</code> and <code>string1 != string2</code>.</li>
</ul>
<p>Reference: <a href="https://www.youtube.com/watch?v=b-mv9iWY8kw">JOverflow: Advanced Heap Analysis in Java Mission Control</a></p>
<h4 id="filtering">Filtering</h4>
<p>As you play with JOverflow, once you click on something, it will begin filtering down your content. If you wish to reduce
down to code that you may own, you can start doing a package filter on the ancestor section. In this example, I want to see duplicate strings for code under <code>cchesser</code>. In this case, I can see that our workshop service has several duplicate
strings (as this content is replicated on each object):</p>
<ul>
<li>Regular Session</li>
<li>4-Hour Workshop</li>
<li>8-Hour Workshop</li>
</ul>
<p>However, the number of instances / overhead is extremely low (since this is a small service), it gives you visibility of areas that you could optimize.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/jmc_overflow_filter_to_ancestor.png" alt="joverflow filter"></p>
<h3 id="eclipse-memory-analyzer">Eclipse Memory Analyzer</h3>
<p><a href="https://eclipse.org/mat/">Eclipse Memory Analyzer</a> is a fairly mature tool on analyzing heap dumps. It is a rich tool that includes the abilities to do OQL queries on the heap, general reporting on anti-patterns, and helpful common views (like the dominator tree). Eclipse Memory Analyzer tool is a separate install which can be a standalone install, or it can run as a plugin within Eclipse. First, install the tool if you haven&rsquo;t already via their <a href="https://eclipse.org/mat/downloads.php">downloads page</a>.</p>
<p>After you have it installed, go to <strong>File</strong> and then <strong>Open Heap Dump&hellip;</strong> and specify the <code>hprof</code> file that you wish to analyze.</p>
<p>💡 When Eclipse Memory Analyzer loads your <code>hprof</code> file, it will create many other index files to assist in optimally analyzing and navigating through your heap dump. It may make it easier to isolate your <code>prof</code> file in its own directory prior to opening it, based on the secondary files which are created. You can always just delete these files within Eclipse Memory Analyzer by opening the <strong>Heap Dump History</strong> window, right-clicking the <code>hprof</code> which was previously loaded, and selecting <strong>Delete Index Files</strong>. Example listing of index files which get generated by suffix:</p>
<ul>
<li><code>.domIn.index</code></li>
<li><code>.domOut.index</code></li>
<li><code>.index</code></li>
<li><code>.o2ret.index</code></li>
<li><code>.a2s.index</code></li>
<li><code>.idx.index</code></li>
<li><code>.inbound.index</code></li>
<li><code>.o2c.index</code></li>
<li><code>.o2hprof.index</code></li>
<li><code>.outbound.index</code></li>
<li><code>.threads</code></li>
</ul>
<h4 id="dominator-tree">Dominator Tree</h4>
<p>A common first area to look at your heap within Eclipse Memory Analyzer is the dominator tree. From the dominator tree, you can organize by the retained heap size, and then begin drilling down the tree to see the contributors to the largest GC roots.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_dominator_tree.png" alt="MAT Dominator Tree"></p>
<h4 id="histogram">Histogram</h4>
<p>The histogram gives you a quick listing of all the top consumers by type. Typically this is going to provide context of the large consumers based on their &ldquo;lower-level&rdquo; types. For example, <code>char[]</code> is a common large contributor, which then will be followed by <code>String</code> which is a type that is predominately weighted by the size of the <code>char[]</code>.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_histogram.png" alt="MAT Thread Overview"></p>
<h4 id="thread-overview">Thread Overview</h4>
<p>The thread overview is a helpful view when you are looking at contributors based on the execution of code. For example, if you have a JVM which has thrown an <code>OutOfMemoryError</code>, you can tell if some type of request caused a massive spike which caused the exhaustion of memory, or if the requests may have not been abnormal, there just wasn&rsquo;t sufficient space to support the request.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_thread_overview.png" alt="MAT Thread Overview"></p>
<h4 id="oql">OQL</h4>
<p>Another strong feature of Eclipse Memory Analyzer is the OQL studio to execute queries to do lookup on objects in your heap.</p>
<p>Lookup our <code>ConferenceSession</code> class type:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#ce5c00;font-weight:bold">*</span>
<span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span>
</code></pre></div><p>💡 To execute the query, you click on the red exclamation mark (:exclamation:). Alternatively, you can press <code>CTRL+Enter</code> on Windows or <code>Command+Enter</code> on macOS.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_oql_studio.png" alt="MAT OQL"></p>
<p>By returning the raw type back, you can expand each one to further look at the contents of the object. If you wanted to just report the object with its <code>title</code> attribute and the object&rsquo;s retained sized, you could do this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">retainedHeapSize</span> 
<span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span> <span style="color:#204a87;font-weight:bold">c</span> 
</code></pre></div><p>Now, you could then filter this by including a <code>WHERE</code> clause, where you can filter it by
the title or the abstract:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">retainedHeapSize</span> <span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span> <span style="color:#204a87;font-weight:bold">c</span> 
<span style="color:#204a87;font-weight:bold">WHERE</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">LIKE</span> <span style="color:#4e9a06">&#34;.*(J|j)ava.*&#34;</span> <span style="color:#204a87;font-weight:bold">OR</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abstract</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">LIKE</span> <span style="color:#4e9a06">&#34;.*(J|j)ava.*&#34;</span>
</code></pre></div><p>Reference: <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html">Eclipse Memory Analyzer OQL Syntax</a></p>

	
	
	<div class="text-muted mt-5 pt-3 border-top">Last modified January 18, 2021: <a  href="https://github.com/cchesser/java-perf-workshop/commit/215298cea4514c7e1db598914b178827bc496027">Correcting bulb references with emoji (215298c)</a>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/cchesser/java-perf-workshop">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 Carl Chesser All Rights Reserved</small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>













<script src="/js/main.min.f820bfc507c3ebefe17f8881ec4ee10013f3b89ad9555a50acf9bb1771e6823f.js" integrity="sha256-&#43;CC/xQfD6&#43;/hf4iB7E7hABPzuJrZVVpQrPm7F3Hmgj8=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>